# extract NFL results

# requirements ------------------------------------------------------------

library(tidyverse)
source('match_results.R')

# parameters --------------------------------------------------------------

saveDir <- read_file(file = './saveDir.txt')

# routine -----------------------------------------------------------------
# the match_results function returns a list of tables scraped from the sports reference website
# containing match results from the years 1992-2023. We then need to spend a bit of code
# tidying this information into a common format with the other results. For example, the sports
# reference website has information on "xG" or expected goals generated by each team during a match
# this statistic if only available in soccer, and is thus removed from the dataset.

# extract EPL results 1992 - 2023 from the pro football reference website
match_results('soccer_epl', yrs = 1992:2023) -> results.epl

# tidying
results.epl %>%
  # the column names from the sports reference website are not R compatible
  unnest(cols = c(match.results.list), names_repair = 'unique') %>%
  # removing empty rows and unncessary columns
  filter(!is.na(Wk)) %>%
  select(-Notes, -xG...14, -xG...15, -`Match Report`, -Referee, -Venue, -Attendance) %>%
  # rename, extracting score, adding columns, reordering columns
  rename(home_team = Home, away_team = Away, Week = Wk) %>%
  mutate(home_team_score = str_extract(Score, '^[0-9]{1,2}')) %>%
  mutate(away_team_score = str_extract(Score, '[0-9]{1,2}$')) %>%
  mutate(across(ends_with('score'), as.integer)) %>%
  add_column(sport = 'soccer', competition = 'epl') %>%
  select(sport, competition, home_team, away_team, home_team_score, away_team_score, season, Week, Date, Time) %>%
  # tidying match time. Some of the early match results from the 1990s do not
  # have the start time, only the start date.
  mutate(Time = str_replace_na(Time, replacement = '')) %>%
  mutate(commence_time = str_c(Date, Time, sep = ' ')) %>%
  mutate(commence_time = str_trim(commence_time)) %>%
  mutate(commence_time = case_when(Time == '' ~ as_datetime(commence_time, format = '%Y-%m-%d'),
                                   .default = as_datetime(commence_time, format = '%Y-%m-%d %H:%M'))) %>%
  select(-Date, -Time) %>%
  mutate(commence_time = format(commence_time, '%Y-%m-%d %H:%M:%S')) %>%
  add_column(id = ids::random_id(nrow(.)), .before = 'sport') %>%
  mutate(Week = as.character(Week)) %>%
  filter(!is.na(home_team_score)) -> results.epl

# write
filePath <- file.path(saveDir, 'epl_results.csv')
write_csv(results.epl, file = filePath)
